# django-orm-tutorial

ä½¿ç”¨ djagno `5.0.6` åŠ ä¸Šé€é `django-extensions` è§€å¯Ÿ ORM å¯¦éš› SQL,

é€²å…¥ shell æ¨¡å¼, è«‹ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤

```cmd
python3 manage.py shell_plus --print-sql
```

å¦‚æœä½ ä¸æƒ³è¦é€é `django-extensions` é€™å€‹æŒ‡ä»¤,

å¯ä»¥ä½¿ç”¨ `str(queryset.query)` æŸ¥çœ‹ SQL æŒ‡ä»¤.

å¦‚æœé€²å…¥ shell æ¨¡å¼, ä½†æ–¹å‘éµæœƒå°å‡ºå¾ˆå¤šå¥‡æ€ªçš„å­—ç¬¦,

åƒæ˜¯é€™æ¨£ `^[[C^[[A^[[A^[[D^[[B^[`

è«‹å®‰è£ä»¥ä¸‹å¥—ä»¶é€²è¡Œä¿®æ­£

```cmd
pip3 install gnureadline
```

## Django åŒ¯å…¥åŒ¯å‡º

dumpdata å’Œ loaddata æ˜¯ django æä¾›åŒ¯å…¥åŒ¯å‡ºçš„ä¸€å€‹å·¥å…·.

- åŒ¯å‡º

å®˜ç¶²å¯åƒè€ƒ [dumpdata](https://docs.djangoproject.com/en/5.0/ref/django-admin/#dumpdata)

```cmd
python manage.py dumpdata > db.json
```

ä¹Ÿå¯ä»¥æŒ‡å®šåŒ¯å‡ºçš„å€‹æ ¼å¼, ä¾‹å¦‚åŒ¯å‡º yaml

```cmd
python3 manage.py dumpdata musics --format yaml > db.yaml
```

åŒ¯å‡ºç‰¹å®šçš„ table

```cmd
python3 manage.py dumpdata musics > db.json
```

- åŒ¯å…¥

å®˜ç¶²å¯åƒè€ƒ [loaddata](https://docs.djangoproject.com/en/5.0/ref/django-admin/#loaddata)

```cmd
python manage.py loaddata db.json
```

è«‹åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤åŒ¯å…¥ demo è³‡æ–™

```cmd
python3 manage.py makemigrations musics
python3 manage.py migrate
python3 manage.py loaddata db.json
```

## Django ORM

æ›´å¤š django orm çš„ç”¨æ³•å¯åƒè€ƒ [querysets](https://docs.djangoproject.com/en/5.0/ref/models/querysets/)

å…ˆä»‹ç´¹ `Q` é€™å€‹æ±è¥¿, é€™å€‹çš„ç›®çš„ä¸»è¦æ˜¯è™•ç†æ›´è¤‡é›œçš„é‚è¼¯é‹ç®—

å¯åƒè€ƒ [Complex lookups with Q objects](https://docs.djangoproject.com/en/5.0/topics/db/queries/#complex-lookups-with-q-objects)

```python
>>> from django.db.models import Q
>>> # é€é Q å»ºç«‹æŸ¥è©¢æ¢ä»¶
>>> condition1 = Q(song__icontains="test")
>>> condition2 = Q(created__gte="2023-01-01")
>>> condition3 = Q(count=3)
>>> # æŸ¥è©¢ song åŒ…å« "test" ä¸¦ä¸” created å¤§æ–¼ç­‰æ–¼ 2023-01-01 æˆ–è€… count ç­‰æ–¼ 3
>>> combined_condition = condition1 & condition2 | condition3
>>> Music.objects.filter(combined_condition)

SELECT "music"."id",
       "music"."song",
       "music"."singer",
       "music"."count",
       "music"."last_modify_date",
       "music"."created",
       "music"."sheet_id",
       "music"."localization"
  FROM "music"
 WHERE ((UPPER("music"."song"::text) LIKE UPPER('%test%') AND "music"."created" >= '2023-01-01T00:00:00+00:00'::timestamptz) OR "music"."count" = 3)

<QuerySet [<Music: Music object (2)>, <Music: Music object (3)>]>
```

Q objects can be negated using the `~` operator, ä¹Ÿå°±æ˜¯ not çš„æ„æ€

```python
>>> from django.db.models import Q
>>> Music.objects.filter(~Q(count=3)).values('id')
SELECT "music"."id"
  FROM "music"
 WHERE NOT ("music"."count" = 3 AND "music"."count" IS NOT NULL)

<QuerySet [{'id': 1}, {'id': 2}, {'id': 4}]>
```

ä»‹ç´¹ `F` é€™å€‹æ±è¥¿, ä»–æ˜¯é‡å°ç‰¹å®šçš„ fields é€²è¡Œæ“ä½œ

```python
>>> from musics.models import Music
>>> from django.db.models import F, Value
>>> from django.db.models.functions import Concat
>>> # å°‡å…¨éƒ¨çš„ song å­—æ®µ åŠ ä¸Š "_data"
>>> Music.objects.update(song=Concat(F('song'),Value('_data')))
UPDATE "music"
   SET "song" = COALESCE("music"."song", '') || COALESCE('_data', '')
3

>>> # å°‡å…¨éƒ¨çš„ count å­—æ®µ åŠ ä¸Š 100
>>> Music.objects.update(count=F('count')+ 100)
UPDATE "music"
   SET "count" = ("music"."count" + 100)
3
```

ä»‹ç´¹ [ArrayField](https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/fields/#arrayfield)

å‡å¦‚æƒ³è¦éæ¿¾ tags, æœ‰åŒ…å« 0 æˆ– 7 æˆ– 3

ç¯„ä¾‹è³‡æ–™å¦‚ä¸‹

```sql
postgres=# SELECT * FROM public.music_tag;
 id |  tags   | music_id
----+---------+----------
  1 | {2,3}   |        4
  2 | {4,5,6} |        3
  3 | {7,8}   |        2
  4 | {0}     |        1
(4 rows)
```

çœ‹ä¸€ä¸‹ table, ä¸»è¦æ˜¯çœ‹ tags, å®ƒçš„ type æ˜¯ text[]

```python
postgres=# \d public.music_tag;
                          Table "public.music_tag"
  Column  |  Type  | Collation | Nullable |             Default
----------+--------+-----------+----------+----------------------------------
 id       | bigint |           | not null | generated by default as identity
 tags     | text[] |           | not null |
 music_id | bigint |           | not null |
```

å¯ä»¥ä½¿ç”¨ [overlap](https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/fields/#overlap) (Uses the SQL operator `&&`)

```python
Music.objects.filter(musictag__tags__overlap=['7', '0', '3'])
<QuerySet [<Music: Music object (4)>, <Music: Music object (2)>, <Music: Music object (1)>]>
```

ä»‹ç´¹ [JSONField](https://docs.djangoproject.com/en/5.0/ref/models/fields/#jsonfield)

ç¯„ä¾‹è³‡æ–™å¦‚ä¸‹

```sql
postgres=# SELECT * FROM public.music;
 id | song | singer | count |      last_modify_date      |          created           | sheet_id |    localization
----+------+--------+-------+----------------------------+----------------------------+----------+--------------------
  4 | data | test   |     0 | 2023-10-07 04:41:00.204+00 | 2023-10-07 03:41:00.204+00 |        3 | {"zh_tw": "data"}
  3 | song | AKB48  |     3 | 2023-10-07 03:41:00.204+00 | 2023-10-07 03:41:00.204+00 |        1 | {"zh_tw": "test"}
  2 | test | AKB48  |     2 | 2023-10-07 03:40:55.581+00 | 2023-10-07 03:40:55.581+00 |        1 | {"es_US": "test2"}
  1 | song | AKB48  |     1 | 2023-10-07 03:40:42.256+00 | 2023-10-07 03:40:42.256+00 |        1 | {"zh_hk": "bbb"}
(4 rows)
```

çœ‹ä¸€ä¸‹ table, ä¸»è¦æ˜¯çœ‹ localization, å®ƒçš„ type æ˜¯ jsonb

```python
postgres=# \d public.music;
                                         Table "public.music"
      Column      |           Type           | Collation | Nullable |             Default
------------------+--------------------------+-----------+----------+----------------------------------
 id               | bigint                   |           | not null | generated by default as identity
 song             | text                     |           | not null |
 singer           | text                     |           | not null |
 count            | integer                  |           |          |
 last_modify_date | timestamp with time zone |           | not null |
 created          | timestamp with time zone |           | not null |
 sheet_id         | bigint                   |           |          |
 localization     | jsonb                    |           |          |
```

```python
# æ‰¾å‡º localization çš„ zh_tw value ç‚º data
Music.objects.filter(localization__zh_tw__icontains='data')
<QuerySet [<Music: Music object (4)>]>

# æ‰¾å‡º localization çš„ key æ˜¯ zh_tw
Music.objects.filter(localization__has_key='zh_tw')
<QuerySet [<Music: Music object (4)>, <Music: Music object (3)>]>

# æ‰¾å‡º localization çš„ key æ˜¯ es_US or zh_hk
Music.objects.filter(localization__has_any_keys=['es_US', 'zh_hk'])
<QuerySet [<Music: Music object (2)>, <Music: Music object (1)>]>
```

ä»‹ç´¹ `query.select_for_update()` å®˜ç¶² å¯åƒè€ƒ [select-for-update](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#select-for-update)


`SELECT ... FOR UPDATE`

```python
>>> from musics.models import Music
>>> from django.db import transaction
>>> with transaction.atomic():
...     Music.objects.select_for_update().get(id=2)
...
SELECT "music"."id",
       "music"."song",
       "music"."singer",
       "music"."count",
       "music"."last_modify_date",
       "music"."created",
       "music"."sheet_id"
  FROM "music"
 WHERE "music"."id" = 2
 LIMIT 21
   FOR UPDATE
```

`SELECT ... FOR UPDATE SKIP LOCKED`

```python
>>> from musics.models import Music
>>> from django.db import transaction
>>> with transaction.atomic():
...     Music.objects.select_for_update(skip_locked=True).get(id=2)
...
SELECT "music"."id",
       "music"."song",
       "music"."singer",
       "music"."count",
       "music"."last_modify_date",
       "music"."created",
       "music"."sheet_id"
  FROM "music"
 WHERE "music"."id" = 2
 LIMIT 21
   FOR UPDATE SKIP LOCKED
```

æ›´å¤šè³‡è¨Šå¯åƒè€ƒæˆ‘ä¹‹å‰ä»‹ç´¹çš„ [Postgresql Lock FOR UPDATE](https://github.com/twtrubiks/postgresql-note/tree/main/pg-lock-tutorial#for-update)

`values`

åªå›å‚³ç‰¹å®š fields çš„å€¼(dict), è€Œä¸æ˜¯å›å‚³æ•´å€‹ model.

```text
Returns a QuerySet that returns dictionaries, rather than model instances, when used as an iterable.
```

å®˜ç¶²å¯åƒè€ƒ [values](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#values)

```python
>>> from musics.models import Music
>>> Music.objects.filter(id=2).values('id', 'song')
<QuerySet [{'id': 2, 'song': 'test_data'}]>
```

`values-list`

é¡ä¼¼ values, ä½†å›å‚³ tuples.

```text
This is similar to values() except that instead of returning dictionaries, it returns tuples when iterated over.
```

å®˜ç¶²å¯åƒè€ƒ [values-list](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#values-list)

```python
>>> from musics.models import Music
>>> Music.objects.filter(id=2).values_list('id', 'song')
<QuerySet [(2, 'test_data')]>

>>> # ä¹Ÿå¯ä»¥å– ForeignKey çš„è³‡æ–™
>>> Music.objects.filter(id=2).values_list('id', 'song', 'sheet__name')
<QuerySet [(2, 'test', 'sheet_1')]>

>>> Music.objects.filter(id=2).values_list('id', flat=True)
<QuerySet [2]>

# there is more than one field
>>> Music.objects.filter(id=2).values_list('id', 'song', named=True)
<QuerySet [Row(id=2, song='test_data')]>
```

`exists`

å®˜ç¶²å¯åƒè€ƒ [exists](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#django.db.models.query.QuerySet.exists)

```python
>>> from musics.models import Music
>>> Music.objects.filter(id=2).exists()
SELECT 1 AS "a"
  FROM "music"
 WHERE "music"."id" = 2
 LIMIT 1

True
```

`only`

åªä½¿ç”¨é¸æ“‡çš„å­—æ®µ.

å®˜ç¶²å¯åƒè€ƒ [only](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#only)

```python
>>> from musics.models import Music
>>> Music.objects.only('song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 LIMIT 21

>>> # æ³¨æ„é †åºæ€§, åªæœ‰æœ€å¾Œçš„æœƒç”Ÿæ•ˆ
>>> Music.objects.only('song', 'singer').only('count')
SELECT "music"."id",
       "music"."count"
  FROM "music"
 LIMIT 21
```

`defer`

å’Œ only ç›¸å, æ’é™¤é¸æ“‡çš„å­—æ®µ

å®˜ç¶²å¯åƒè€ƒ [defer](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#defer)

```python
>>> from musics.models import Music
>>> # æ’é™¤ 'song', 'singer', 'created'
>>> Music.objects.defer('song', 'singer', 'created')
SELECT "music"."id",
       "music"."count",
       "music"."last_modify_date",
       "music"."sheet_id",
       "music"."localization"
  FROM "music"
 LIMIT 21
```

`reverse`

å®˜ç¶²å¯åƒè€ƒ [reverse](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#reverse)

é€™å€‹æˆ‘è¦ºçš„æ²’ä»€éº¼ç”¨, å› ç‚ºç›´æ¥ä½¿ç”¨ `order_by("id")` `order_by("-id")` æ§åˆ¶å°±å¯ä»¥äº†.

```python
>>> from musics.models import Music
>>> # éœ€è¦æ­é… orderby
>>> Music.objects.all().only("singer").order_by("id")
SELECT "music"."id",
       "music"."singer"
  FROM "music"
 ORDER BY "music"."id" ASC

>>> Music.objects.all().only("singer").order_by("id").reverse()
SELECT "music"."id",
       "music"."singer"
  FROM "music"
 ORDER BY "music"."id" DESC
```

`latest` `earliest`

å­˜åœ¨çš„ç›®çš„åªæ˜¯ç‚ºäº†å¯è®€æ€§.

å®˜ç¶²å¯åƒè€ƒ [latest](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#latest)

å®˜ç¶²å¯åƒè€ƒ [earliest](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#earliest)

```python
>>> from musics.models import Music
>>> Music.objects.filter(created__isnull=False).latest("singer")
SELECT "music"."id",
       "music"."song",
       "music"."singer",
       "music"."count",
       "music"."last_modify_date",
       "music"."created",
       "music"."sheet_id",
       "music"."localization"
  FROM "music"
 WHERE "music"."created" IS NOT NULL
 ORDER BY "music"."singer" DESC
 LIMIT 1

>>> Music.objects.filter(created__isnull=False).earliest("singer")
SELECT "music"."id",
       "music"."song",
       "music"."singer",
       "music"."count",
       "music"."last_modify_date",
       "music"."created",
       "music"."sheet_id",
       "music"."localization"
  FROM "music"
 WHERE "music"."created" IS NOT NULL
 ORDER BY "music"."singer" ASC
 LIMIT 1
```


`explain`

å¯ä»¥çœ‹ execution plan

å®˜ç¶²å¯åƒè€ƒ [explain](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#explain)

```python
>>> from musics.models import Music
>>> Music.objects.only('id', 'singer').filter(created__isnull=False).explain()
EXPLAIN SELECT "music"."id",
       "music"."singer"
  FROM "music"
 WHERE "music"."created" IS NOT NULL
'Seq Scan on music  (cost=0.00..15.10 rows=507 width=40)\n  Filter: (created IS NOT NULL)'

>>> Music.objects.only('id', 'singer').filter(pk=2).explain()
EXPLAIN SELECT "music"."id",
       "music"."singer"
  FROM "music"
 WHERE "music"."id" = 2

'Index Scan using music_pkey on music  (cost=0.15..8.17 rows=1 width=40)\n  Index Cond: (id = 2)'
```

`exact`

Exact match. å¿½ç•¥å¤§å°å¯«å¯ä½¿ç”¨ `iexact`

å®˜ç¶²å¯åƒè€ƒ [exact](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#exact)

```python
>>> from musics.models import Music

>>> Music.objects.filter(id__exact=1).values('id')
SELECT "music"."id"
  FROM "music"
 WHERE "music"."id" = 1

<QuerySet [{'id': 1}]>


>>> Music.objects.filter(song__exact=None).values('id')
SELECT "music"."id"
  FROM "music"
 WHERE "music"."song" IS NULL

<QuerySet []>

>>> Music.objects.filter(song__exact="").values('id')
SELECT "music"."id"
  FROM "music"
 WHERE "music"."song" = ''

<QuerySet []>
```

å…¶å¯¦é€™å€‹èªæ³•å’Œåº•ä¸‹çš„èªæ³•æ‰€ç”¢ç”Ÿçš„ SQL æ˜¯ä¸€æ¨£çš„,

```python
Music.objects.filter(song="").values('id')
```

`distinct`

å®˜ç¶²å¯åƒè€ƒ [distinct](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#distinct)

```python
>>> from musics.models import Music
>>> Music.objects.distinct("count").values_list('id')
SELECT DISTINCT
    ON ("music"."count") "music"."id"
  FROM "music"

<QuerySet [(4,), (1,), (2,), (3,)]>
```

å¦‚æœæ­é… order_by è¦ç¨å¾®æ³¨æ„ä¸€ä¸‹

```python
>>> from musics.models import Music
>>> Music.objects.order_by("count").distinct("count").values_list('id')
SELECT DISTINCT
    ON ("music"."count") "music"."id"
  FROM "music"
 ORDER BY "music"."count" ASC

<QuerySet [(2,)]>
```

å¦‚æœ distinct çš„æ¬„ä½æ²’æœ‰åœ¨ order_by ä¸­æœƒéŒ¯èª¤ ğŸ˜±, å¦‚ä¸‹

```python
>>> from musics.models import Music
>>> Music.objects.order_by("id").distinct("count").values_list('id')
django.db.utils.ProgrammingError: SELECT DISTINCT ON expressions must match initial ORDER BY expressions
```

`exclude`

å®˜ç¶²å¯åƒè€ƒ [exclude](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#exclude)

```python
>>> from musics.models import Music
>>> Music.objects.exclude(singer="test").values_list('id')

SELECT "music"."id"
  FROM "music"
 WHERE NOT ("music"."singer" = 'test')

<QuerySet [(1,), (2,), (3,)]>
```

`contains`

å®˜ç¶²å¯åƒè€ƒ [contains](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#contains)

```python
>>> Music.objects.filter(song__contains='on').values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE "music"."song"::text LIKE '%on%'

<QuerySet [(3, 'song'), (1, 'song')]>
```

`icontaons`

Case-insensitive å¿½ç•¥å¤§å°å¯«

å®˜ç¶²å¯åƒè€ƒ [icontaons](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#contains)

```python
>>> Music.objects.filter(song__icontains='on').values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE UPPER("music"."song"::text) LIKE UPPER('%on%')

<QuerySet [(3, 'song'), (1, 'song')]>
```

å‡å¦‚æˆ‘æƒ³è¦åŒæ™‚æ‰¾å‡º song æœ‰åŒ…å« "on" æˆ–æ˜¯ "es" çš„, å¿…é ˆæ­é… `Q`

```python
>>> from django.db.models import Q
>>> Music.objects.filter(Q(song__icontains='on') | Q(song__icontains='es'))
SELECT "music"."id",
       "music"."song",
       "music"."singer",
       "music"."count",
       "music"."last_modify_date",
       "music"."created",
       "music"."sheet_id",
       "music"."localization"
  FROM "music"
 WHERE (UPPER("music"."song"::text) LIKE UPPER('%on%') OR UPPER("music"."song"::text) LIKE UPPER('%es%'))

<QuerySet [<Music: Music object (3)>, <Music: Music object (2)>, <Music: Music object (1)>]>
```

`startswith`

å®˜ç¶²å¯åƒè€ƒ [startswith](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#startswith)

```python
>>> Music.objects.filter(song__startswith='te').values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE "music"."song"::text LIKE 'te%'

<QuerySet [(2, 'test')]>
```

`endswith`

å®˜ç¶²å¯åƒè€ƒ [endswith](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#endswith)

```python
>>> Music.objects.filter(song__endswith='t').values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE "music"."song"::text LIKE '%t'

<QuerySet [(2, 'test')]>
```

`date`

å®˜ç¶²å¯åƒè€ƒ [date](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#date)

```python
>>> from datetime import datetime, date
>>> Music.objects.filter(last_modify_date__date=date(2023, 10, 7)).values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE ("music"."last_modify_date" AT TIME ZONE 'UTC')::date = '2023-10-07'::date

<QuerySet [(4, 'data'), (3, 'song'), (2, 'test'), (1, 'song')]>
```

`range`

å®˜ç¶²å¯åƒè€ƒ [range](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#range)

```python
>>> from datetime import datetime, date
>>> start_date = date(2023, 1, 1)
>>> end_date = date(2023, 12, 31)
>>> Music.objects.filter(last_modify_date__range=(start_date, end_date)).values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE "music"."last_modify_date" BETWEEN '2023-01-01T00:00:00+00:00'::timestamptz AND '2023-12-31T00:00:00+00:00'::timestamptz

<QuerySet [(4, 'data'), (3, 'song'), (2, 'test'), (1, 'song')]>
```

`isnull`

å®˜ç¶²å¯åƒè€ƒ [isnull](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#isnull)

```python
>>> Music.objects.filter(sheet__isnull=True).values_list('id', 'song')
SELECT "music"."id",
       "music"."song"
  FROM "music"
 WHERE "music"."sheet_id" IS NULL

<QuerySet []>
```

`aggregate`

ç›´æ¥æŠŠä»–æƒ³æˆå°±æ˜¯ èšåˆå‡½æ•¸,

å®˜ç¶²å¯åƒè€ƒ [aggregation](https://docs.djangoproject.com/en/5.0/topics/db/aggregation/) (å€¼å¾—èŠ±æ™‚é–“çœ‹çœ‹)

```python
>>> from musics.models import Music
>>> from django.db.models import Avg, Sum
>>> Music.objects.aggregate(sum_count=Sum('count'))
SELECT SUM("music"."count") AS "sum_count"
  FROM "music"
Execution time: 0.000510s [Database: default]
{'sum_count': 6}

>>> Music.objects.all().aggregate(avg_count=Avg('count'))
SELECT AVG("music"."count") AS "avg_count"
  FROM "music"
Execution time: 0.000367s [Database: default]
{'avg_count': 2.0}
```

`annotate`

åŸç†ä¸€æ¨£æ˜¯ä½¿ç”¨ group by, ä½†æ˜¯å®ƒå¼·å¤§çš„åœ°æ–¹åœ¨æ–¼, å¯ä»¥åœ¨åŸæœ¬çš„ model ä¸Šå¢åŠ æ–°çš„å­—æ®µ,

```python
>>> from musics.models import Music, Sheet
>>> from django.db.models import Avg, Sum, Count

>>> # è¨ˆç®—å‡ºæ¯å€‹ sheet åº•ä¸‹æœ‰å¤šå°‘å€‹ music
>>> Sheet.objects.annotate(num_music=Count("music"))
SELECT "musics_sheet"."id",
       "musics_sheet"."name",
       COUNT("music"."id") AS "num_music"
  FROM "musics_sheet"
  LEFT OUTER JOIN "music"
    ON ("musics_sheet"."id" = "music"."sheet_id")
 GROUP BY "musics_sheet"."id"
 LIMIT 21

>>> sheet = Sheet.objects.annotate(num_music=Count("music"))
>>> sheet[0].num_music # å¯ä»¥ä½¿ç”¨è¨ˆç®—å‡ºä¾†çš„å­—æ®µ
>>> sheet.filter(num_music__gt=1) # ç”šè‡³å¯ä»¥ä½¿ç”¨ ORM ä¾†éæ¿¾è‡ªå®šç¾©çš„å­—æ®µ

>>> # ä¾†çœ‹ä¸€ä¸‹ SQL, å…¶å¯¦å°±æ˜¯ç”¨ HAVING
>>> Sheet.objects.annotate(num_music=Count("music")).filter(num_music__gt=1)
SELECT "tutorial_sheet"."id",
       "tutorial_sheet"."name",
       COUNT("music"."id") AS "num_music"
  FROM "tutorial_sheet"
  LEFT OUTER JOIN "music"
    ON ("tutorial_sheet"."id" = "music"."sheet_id")
 GROUP BY "tutorial_sheet"."id"
HAVING COUNT("music"."id") > 1
 LIMIT 21


>>> # å¦‚æœæƒ³è¦æ’åº, å¯ä»¥å†åŠ ä¸Š order_by
>>> Sheet.objects.annotate(num_music=Count("music")).order_by("-num_music")
SELECT "musics_sheet"."id",
       "musics_sheet"."name",
       COUNT("music"."id") AS "num_music"
  FROM "musics_sheet"
  LEFT OUTER JOIN "music"
    ON ("musics_sheet"."id" = "music"."sheet_id")
 GROUP BY "musics_sheet"."id"
 ORDER BY 3 DESC
 LIMIT 21


>>> # ä¾ç…§ song é€²è¡Œ group by, ä¸¦ä¸”é‡å° count é€²è¡Œ sum é‹ç®—
>>> Music.objects.values('song').annotate(sum_count=Sum('count'))
SELECT "music"."song",
       SUM("music"."count") AS "sum_count"
  FROM "music"
 GROUP BY "music"."song"
 LIMIT 21
Execution time: 0.000687s [Database: default]
<QuerySet [{'song': 'test', 'sum_count': 2}, {'song': 'song', 'sum_count': 4}]>
```

`conditional-expressions`

åœ¨è³‡æ–™åº«ä¸­çš„ When Case, django ä¹Ÿå¯ä»¥ä½¿ç”¨

å®˜ç¶²å¯åƒè€ƒ [conditional-expressions](https://docs.djangoproject.com/en/5.0/ref/models/conditional-expressions/)

```python
>>> from musics.models import Music
>>> from django.db.models import Case, When, Value
>>> Music.objects.annotate(
...      my_data=Case(
...          When(count=1, then=Value("5%")),
...          When(count=2, then=Value("10%")),
...          default=Value("0%")
...       )
...     ).values_list("id", "my_data")
SELECT "music"."id",
       CASE WHEN "music"."count" = 1 THEN '5%'
            WHEN "music"."count" = 2 THEN '10%'
            ELSE '0%'
             END AS "my_data"
  FROM "music"
 LIMIT 21
Execution time: 0.000468s [Database: default]
<QuerySet [(1, '5%'), (2, '10%'), (3, '0%')]>
```

`bulk-create`

[bulk-create](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#bulk-create)

```python
from musics.models import Music
Music.objects.bulk_create([
    Music(song="song11", singer="singer11"),
    Music(song="song22", singer="singer22"),
])
```

å°æ‡‰çš„åŸç”Ÿ sql å¦‚ä¸‹,

```sql
INSERT INTO "music" ("song", "singer", "count", "last_modify_date", "created", "sheet_id")
VALUES ('song11', 'singer11', NULL, '2024-04-09 12:04:46.046720', '2024-04-09 12:04:46.046765', NULL), ('song22', 'singer22', NULL, '2024-04-09 12:04:46.046796', '2024-04-09 12:04:46.046811', NULL)
```

é‚„æœ‰ä¸€å€‹ batch_size å¯ä»¥ä½¿ç”¨, ç”¨ä¾†å®Œæˆæ‰¹æ¬¡(ä¸€æ¬¡æœ€å¤šæ–°å¢å¹¾æ¯”).

ä¾‹å¦‚

```python
Music.objects.bulk_create([
    Music(song="song11", singer="singer11"),
    Music(song="song22", singer="singer22"),
    Music(song="song33", singer="singer33"),
    Music(song="song44", singer="singer44"),
], 2)
```

å¦‚æœä½ çœ‹åŸç”Ÿ SQL ä½ æœƒç™¼ç¾åŸ·è¡Œäº†å…©å€‹ INSERT INTO.

`bulk-update`

[bulk-update](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#bulk-update)

```python
from musics.models import Music
musics = []
for index, music in enumerate(Music.objects.all()):
    music.song = f"song_{index}"
    musics.append(music)

bulk_update_count = Music.objects.bulk_update(musics, ['song'])
```

bulk_update_count æœƒå›å‚³æ›´æ–°çš„æ¯”æ•¸.

å°æ‡‰çš„åŸç”Ÿ sql å¦‚ä¸‹,

```sql
UPDATE "music"
   SET "song" =
      CASE WHEN ("music"."id" = 1) THEN 'song_0'
           WHEN ("music"."id" = 2) THEN 'song_1'
      ELSE NULL
      END
 WHERE "music"."id" IN (1, 2)
```

`get_or_create`

[get_or_create](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#get-or-create)

å¦‚æœæœ‰ç¬¦åˆçš„è³‡æ–™ä¸”åªæœ‰ä¸€æ¯”å°±å›å‚³, æ²’æœ‰çš„è©±å°±å»ºç«‹.

```python
from musics.models import Music
obj, created = Music.objects.get_or_create(song="song113")
```

obj æœƒå›å‚³ç‰©ä»¶, created å‰‡æœƒå›å‚³æ˜¯å¦æœ‰å»ºç«‹.

ç‚ºäº†é¿å… concurrent requests çš„éŒ¯èª¤, é€é get_or_create æœƒæ›´å¥½,

å¦‚æœä»Šå¤©å¤šæ¯”è¢«æ‰¾åˆ°, æœƒè·³å‡º raises MultipleObjectsReturned.

`update_or_create`

[update_or_create](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#get-or-create)


```python
from musics.models import Music
obj, created = Music.objects.update_or_create(
    song="song113",
    defaults={"song": "song_default"},
)
```

obj æœƒå›å‚³ç‰©ä»¶, created å‰‡æœƒå›å‚³æ˜¯å¦æœ‰å»ºç«‹.

å¦‚æœæ‰¾åˆ° song ç‚º song113, å°±å°‡æ‰¾åˆ°çš„å–®æ¯”çš„ song æ›´æ–°ç‚º song_default,

å¦‚æœæ²’æ‰¾åˆ°, å°±ç”¨ create_defaults è£¡é¢çš„å…§å®¹å»ºç«‹,

å¦‚æœä»Šå¤©å¤šæ¯”è¢«æ‰¾åˆ°, æœƒè·³å‡º raises MultipleObjectsReturned.

`in-bulk`

[in-bulk](https://docs.djangoproject.com/en/5.0/ref/models/querysets/#in-bulk)

```python
from musics.models import Music
Music.objects.in_bulk([1, 2])
# {1: <Music: Music object (1)>, 2: <Music: Music object (2)>}

# å¦‚æœæ²’æœ‰æŒ‡å®š, æœƒæ‰¾å‡ºå…¨éƒ¨çš„
Music.objects.in_bulk()
```

`Func() expressions`

ä½¿ç”¨ database functions like COALESCE and LOWER

[Func() expressions](https://docs.djangoproject.com/en/5.0/ref/models/expressions/#func-expressions)

ç¯„ä¾‹, å°‡å­—ä¸²æ”¹æˆå¤§å¯«,

```python
>>> from django.db.models import Func
>>> from musics.models import Music
>>> class Upper(Func):
...     function = "UPPER"
...

>>> Music.objects.annotate(song_upper=Upper("song")).values_list("id", "song_upper", "song")
SELECT "music"."id",
       "music"."song",
       UPPER("music"."song") AS "song_upper"
  FROM "music"

<QuerySet [(4, 'DATA', 'data'), (3, 'SONG', 'song'), (2, 'TEST', 'test'), (1, 'SONG', 'song')]>
```

ç¯„ä¾‹, å°‡ array å…¨éƒ¨å±•é–‹,

```python
>>> from django.db.models import Func, CharField
>>> from musics.models import MusicTag
>>> class Unnest(Func):
...     function = "unnest"
...     output_field = CharField()
...

>>> MusicTag.objects.annotate(tag_name=Unnest("tags")).values_list("id", "tag_name", "tags")
SELECT "music_tag"."id",
       "music_tag"."tags",
       unnest("music_tag"."tags") AS "tag_name"
  FROM "music_tag"

<QuerySet [(1, '2', ['2', '3']), (1, '3', ['2', '3']), (2, '4', ['4', '5', '6']), (2, '5', ['4', '5', '6']), (2, '6', ['4', '5', '6']), (3, '7', ['7', '8']), (3, '8', ['7', '8']), (4, '0', ['0'])]>
```

`custom lookups`

[How to write custom lookups](https://docs.djangoproject.com/en/5.0/howto/custom-lookups/)

è‡ªå·±å®šç¾© lookups, å¯åƒè€ƒ [models.py](https://github.com/twtrubiks/django-tutorial/blob/django4_and_orm/musics/models.py#L44)

```python
@Field.register_lookup
class NotEqual(Lookup):
    lookup_name = "ne"

    def as_sql(self, compiler, connection):
        lhs, lhs_params = self.process_lhs(compiler, connection)
        rhs, rhs_params = self.process_rhs(compiler, connection)
        params = lhs_params + rhs_params
        return "%s <> %s" % (lhs, rhs), params
```

å¦‚æœæƒ³è¦ debug `as_sql` è£¡é¢çš„æ±è¥¿, è¦è§¸ç™¼é€™å€‹ä¸­æ–·é»è«‹ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤,

é€™æ¨£ä½ å°±å¯ä»¥çœ‹å‡ºå®ƒçµ„å‡ºä»€éº¼å­—ä¸².

```python
print(Music.objects.filter(song__ne='test').query)
```

ç¶“éä¸Šé¢é€™æ¨£çš„å®šç¾©, å¯ä»¥ä½¿ç”¨è‡ªå·±å®šç¾©çš„ `ne`,

`<> 'test'` åœ¨ SQL ä¸­çš„æ„æ€æ˜¯ä¸ç­‰æ–¼ test çš„æ„æ€

```python
>>> Music.objects.filter(song__ne='test').values_list("song")
SELECT "music"."song"
  FROM "music"
 WHERE "music"."song" <> 'test'

<QuerySet [('data',), ('song',), ('song',)]>
```

## Performing raw SQL queries

å®˜ç¶²å¯åƒè€ƒ [Performing raw SQL queries](https://docs.djangoproject.com/en/5.0/topics/db/sql/)

```python
>>> result = Music.objects.raw('SELECT * FROM music where song ilike %s', [f"%song%"])
>>> [(rec.id, rec.song) for rec in result]
[(3, 'song'), (1, 'song')]
```

## åŸ·è¡Œç’°å¢ƒ

* Python 3.10.12

## Reference

* [Django](https://www.djangoproject.com/)

## Donation

æ–‡ç« éƒ½æ˜¯æˆ‘è‡ªå·±ç ”ç©¶å…§åŒ–å¾ŒåŸå‰µï¼Œå¦‚æœæœ‰å¹«åŠ©åˆ°æ‚¨ï¼Œä¹Ÿæƒ³é¼“å‹µæˆ‘çš„è©±ï¼Œæ­¡è¿è«‹æˆ‘å–ä¸€æ¯å’–å•¡:laughing:

![alt tag](https://i.imgur.com/LRct9xa.png)

[è´ŠåŠ©è€…ä»˜æ¬¾](https://payment.opay.tw/Broadcaster/Donate/9E47FDEF85ABE383A0F5FC6A218606F8)

## License

MIT license
